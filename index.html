<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>苏轼与徐霞客行迹图</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>
  <body>
    <!-- 顶部导航栏 -->
    <nav id="top-navigation">
      <div class="nav-container">
        <div class="nav-title">苏轼与徐霞客行迹图</div>
        <div class="nav-items" id="nav-items">
          <!-- 导航项将通过 JavaScript 动态生成 -->
        </div>
        <button id="help-btn" class="nav-help-btn">关于此图</button>
      </div>
    </nav>

    <div id="container">
      <!-- 左侧地图容器 -->
      <div id="map" class="panel-visible"></div>

      <!-- 右侧控制面板 -->
      <div id="right-control-panel">
        <!-- 心境分析标题（仿照“事件列表”标题样式） -->
        <div class="control-section mood-header-section">
          <div class="events-header-left">
            <h4 class="section-title-inline">相关原文</h4>
          </div>
        </div>

        <!-- 心境分析内容容器（仿照事件列表容器，高度固定为 90） -->
        <div class="control-section mood-list-section">
          <div id="mood-list-container" class="events-list-container mood-list-container">
            <div class="mood-list-item">
              正在加载相关原文...
            </div>
          </div>
        </div>

        <!-- 第一行：播放控制按钮 + 播放速度 -->
        <div class="control-section player-and-speed-section">
          <button class="player-btn" id="prev-btn" title="上一个事件">
            ⬅
          </button>
          <button class="player-btn" id="play-btn" title="播放">▶</button>
          <button class="player-btn" id="next-btn" title="下一个事件">
            ⮕
          </button>
          <div class="speed-divider"></div>
          
          <div class="speed-control-compact">
            <span class="speed-label-compact">速度</span>
            <div class="custom-select-wrapper">
              <div
                class="custom-select"
                id="speed-select-top"
                data-value="5000"
              >
                <div class="select-display">
                  <span class="select-text">正常</span>
                  <span class="select-arrow">▼</span>
                </div>
                <div class="select-dropdown">
                  <div class="select-option " data-value="3500">很快</div>
                  <div class="select-option selected" data-value="5000">正常</div>
                  <div class="select-option" data-value="7000">较慢</div>
                  <div class="select-option" data-value="10000">很慢</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 第二行：事件列表标题 + 时间范围 + 统计icon -->
        <div class="control-section events-header-section">
          <div class="events-header-left">
            <h4 class="section-title-inline">事件列表</h4>
            <div class="time-range-compact">
              <span class="time-range-text" id="time-range-start-top">-</span>
              <span class="time-range-separator">~</span>
              <span class="time-range-text" id="time-range-end-top">-</span>
            </div>
          </div>
          <button class="full-route-btn" id="full-route-btn" title="全局路线">
            一键展示全局路线
          </button>
        </div>

        <!-- 第三行：事件列表内容 -->
        <div class="control-section events-list-section">
          <div id="events-list-container" class="events-list-container">
            <div class="loading-events">正在加载事件列表...</div>
          </div>
        </div>

        <!-- 统计信息弹出层 -->
        <div class="stats-popup" id="stats-popup">
          <div class="stats-popup-header">
            <h4>📊 统计信息</h4>
            <button class="stats-popup-close" id="stats-popup-close">×</button>
          </div>
          <div class="stats-popup-content">
            <div class="stats-item">
              <span class="stats-label">总事件数:</span>
              <span class="stats-value" id="total-events">-</span>
            </div>
            <div class="stats-item">
              <span class="stats-label">移动次数:</span>
              <span class="stats-value" id="movement-count">-</span>
            </div>
            <div class="stats-item">
              <span class="stats-label">访问省市:</span>
              <span class="stats-value" id="visited-places">-</span>
            </div>
            <div class="stats-item">
              <span class="stats-label">国际移动:</span>
              <span class="stats-value" id="international-count">-</span>
            </div>
            <div class="stats-item">
              <span class="stats-label">时间跨度:</span>
              <span class="stats-value" id="time-span">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 悬停检测区域（PC端） - 隐藏 -->
      <div id="stats-hover-area" style="display: none;"></div>

      <!-- 控制面板切换按钮（移动端） -->
      <button
        id="toggle-panel-btn"
        class="toggle-panel-btn"
        title="切换控制面板"
      >
        ⚙
      </button>

      <!-- 时间轴控制 - 移动端使用 -->
      <div id="timeline-control" style="display: none;">
        <!-- 当前事件信息（移动端） -->
        <div class="current-event-section">
          <div class="event-info-row">
            <div class="event-date-mobile" id="event-date-mobile">
              加载中...
            </div>
            <div class="event-location-mobile" id="event-location-mobile">
              加载中...
            </div>
          </div>
          <div class="event-info-row">
            <div class="event-title-mobile" id="event-title-mobile">
              加载中...
            </div>
          </div>
          <div class="progress-info-mobile">
            <div class="info-item">
              <span class="info-label">事件:</span>
              <span class="info-value">
                <span id="current-event-index-mobile">1</span>/<span
                  id="total-event-count-mobile"
                  >-</span
                >
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">年龄:</span>
              <span class="info-value">
                <span id="current-age-mobile">0</span
                ><span class="info-unit">岁</span>
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">进度:</span>
              <span class="info-value" id="current-progress-mobile">0%</span>
            </div>
          </div>
        </div>

        <div class="timeline-info">
          <div class="time-point start">
            <span class="label">开始</span>
            <span class="value" id="time-range-start-mobile">-</span>
          </div>

          <!-- 当前事件详情区域（PC端） -->
          <div class="current-event-details">
            <div class="event-date" id="event-date">加载中...</div>
            <div class="event-title" id="event-title">加载中...</div>
            <div class="event-location" id="event-location">加载中...</div>
          </div>

          <div class="time-point end">
            <span class="label">结束</span>
            <span class="value" id="time-range-end-mobile">-</span>
          </div>
        </div>

        <div class="player-controls">
          <div class="player-controls-row">
            <!-- 播放控制按钮 -->
            <div class="player-buttons">
              <button class="player-btn" id="prev-btn" title="上一个事件">
                ⏮
              </button>
              <button class="player-btn" id="play-btn" title="播放">▶</button>
              <button class="player-btn" id="next-btn" title="下一个事件">
                ⏭
              </button>
            </div>

            <!-- 速度控制（移动端） -->
            <div class="speed-control">
              <button class="speed-btn" data-speed="3500">快</button>
              <button class="speed-btn active" data-speed="5000">中</button>
              <button class="speed-btn" data-speed="7000">慢</button>
            </div>
          </div>

          <!-- 进度条区域 -->
          <div class="progress-section">
            <div class="progress-container">
              <input
                type="range"
                id="timeline-slider"
                min="0"
                max="100"
                value="0"
                tabindex="0"
                title="使用左右方向键或拖拽控制时间轴"
              />
            </div>
            <div class="progress-details">
              <span class="progress-item"
                >事件: <span id="current-event-index-desktop">1</span>/<span
                  id="total-event-count-desktop"
                  >-</span
                ></span
              >
              <span class="progress-item"
                >年龄: <span id="current-age-desktop">0</span>岁</span
              >
              <span class="progress-item"
                >进度: <span id="current-progress-desktop">0%</span></span
              >
            </div>
          </div>

          <!-- 速度控制（PC端） -->
          <div class="player-speed">
            <label class="speed-label">播放速度:</label>
            <div class="custom-select-wrapper">
              <div
                class="custom-select"
                id="speed-select-bottom"
                data-value="5000"
              >
                <div class="select-display">
                  <span class="select-text">正常</span>
                  <span class="select-arrow">▼</span>
                </div>
                <div class="select-dropdown">
                  <div class="select-option selected" data-value="1500">很快</div>
                  <div class="select-option" data-value="3000">
                    正常
                  </div>
                  <div class="select-option" data-value="5000">较慢</div>
                  <div class="select-option" data-value="8000">很慢</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 详细信息面板背景遮罩 -->
      <div id="panel-backdrop" class="panel-backdrop"></div>

      <!-- 详细信息面板 -->
      <div id="location-detail-panel" class="location-detail-panel">
        <div class="panel-header">
          <div class="panel-drag-handle"></div>
          <h3 id="panel-location-title">地点详情</h3>
          <div class="visit-summary" id="panel-visit-summary">
            截止当前时间点共访问 <span class="visit-count-highlight">0</span> 次
          </div>
          <button class="panel-close" id="panel-close-btn" title="关闭">
            ×
          </button>
        </div>
        <div class="panel-content" id="panel-content">
          <!-- 事件列表 -->
        </div>
      </div>

      <!-- 加载提示 -->
      <div id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在加载轨迹数据...</div>
      </div>
    </div>

    <!-- 版权信息 -->
    <footer class="site-footer">
      @中国地质大学北京-中国文化研究-2025秋结课作业-江旭
    </footer>

    <!-- 引导弹窗 -->
    <div id="intro-modal" class="intro-modal">
      <div class="intro-content">
        <div class="intro-header">
          <h2>逆境地图：追寻巨人的苦难与辉煌</h2>
          <p class="intro-subtitle">—— 苦难如何铸就伟大 ——</p>
        </div>
        
        <div class="intro-body">
          <div class="intro-theme-text">
            <p>“古之立大事者，不惟有超世之才，亦必有坚忍不拔之志。”</p>
            <p>本图专注于苏轼南贬与徐霞客西南远征中<strong>最艰难</strong>的旅程。通过追踪他们的足迹与心境变化，我们试图探寻：<strong>当人生跌入谷底时，伟大的灵魂是如何在逆境中重塑自我的？</strong></p>
          </div>
          
          <div class="intro-guide">
            <h3>🗺️ 使用指南</h3>
            <div class="guide-steps">
              <div class="step">
                <span class="step-icon">▶️</span>
                <p>点击<strong>播放</strong>，跟随巨人的足迹前行。</p>
              </div>
              <div class="step">
                <span class="step-icon">🧠</span>
                <p>观察左侧<strong>心境分析</strong>，通过原文感受其内心的波澜。</p>
              </div>
              <div class="step">
                <span class="step-icon">📍</span>
                <p>点击右侧的<strong>事件列表</strong>，快速定位具体的历史事件发生地。</p>
              </div>
            </div>
          </div>
        </div>

        <div class="intro-footer">
          <button id="start-journey-btn" class="start-btn">开启旅程</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Igor-Vladyka/leaflet.motion/dist/leaflet.motion.min.js"></script>
    <script type="module" src="assets/js/main.js"></script>
  </body>
</html>
